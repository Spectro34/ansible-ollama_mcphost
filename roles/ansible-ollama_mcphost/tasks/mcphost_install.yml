- name: Detect distribution information (without gathered facts)
  ansible.builtin.shell: |
    if [ -r /etc/os-release ]; then
      . /etc/os-release
      printf "%s|%s" "${ID:-}" "${VERSION_ID:-}"
    fi
  args:
    executable: /bin/bash
  register: mcphost_os_release
  changed_when: false
  failed_when: false
  tags: ['mcphost', 'install']

- name: Cache distribution facts for repo decisions
  ansible.builtin.set_fact:
    mcphost_detected_distribution: "{{ (mcphost_os_release.stdout | default('')).split('|')[0] | default('') | lower }}"
    mcphost_detected_distribution_major: "{{ ((mcphost_os_release.stdout | default('')).split('|')[1] | default('')).split('.')[0] | default('') }}"
  when: mcphost_os_release.stdout is defined and mcphost_os_release.stdout | length > 0

- name: Check if zypper is available
  ansible.builtin.stat:
    path: /usr/bin/zypper
  register: mcphost_zypper_stat

- name: Gather package facts (when zypper is present)
  ansible.builtin.package_facts:
    manager: auto
  when: mcphost_zypper_stat.stat.exists | default(false)

- name: Compute package availability flags
  ansible.builtin.set_fact:
    mcphost_package_available: "{{ (ansible_facts.packages[mcphost_package_name] | default([])) | length > 0 }}"
    ollama_package_available: "{{ (ansible_facts.packages[ollama_package_name] | default([])) | length > 0 }}"
  when:
    - mcphost_zypper_stat.stat.exists | default(false)
    - ansible_facts.packages is defined

- name: Determine if SLE16 MCP repository is required
  ansible.builtin.set_fact:
    sle16_repo_required: >-
      {{
        (sle16_mcp_repo_enabled | bool)
        and (mcphost_zypper_stat.stat.exists | default(false))
        and ((mcphost_detected_distribution | default('')) in ['sles'])
        and (((mcphost_detected_distribution_major | default('0')) | int) >= 16)
        and (
          (not (mcphost_package_available | default(false)))
          or (not (ollama_package_available | default(false)))
        )
      }}

- name: Add SLE16 MCP repository (if enabled and on SLE16)
  community.general.zypper_repository:
    name: "{{ sle16_mcp_repo_name }}"
    repo: "{{ sle16_mcp_repo_url }}"
    state: present
    disable_gpg_check: false
    auto_import_keys: true
  become: true
  when:
    - sle16_repo_required | default(false)
  tags: ['mcphost', 'install']

- name: Install mcphost
  ansible.builtin.package:
    name: "{{ mcphost_package_name }}"
    state: present
  become: true
  tags: ['mcphost', 'install']

- name: Ensure mcphost config directory exists
  ansible.builtin.file:
    path: "{{ mcphost_config_path | dirname }}"
    state: directory
    mode: "0755"
  tags: ['mcphost', 'config']

- name: Resolve API key from environment variable if specified
  ansible.builtin.set_fact:
    mcphost_provider_api_key_resolved: "{{ lookup('ansible.builtin.env', env_var_name) }}"
  vars:
    env_var_name: "{{ mcphost_provider_api_key_env_var | default('') | trim }}"
  when: env_var_name | length > 0
  failed_when: false

- name: Set API key to direct value if no env var specified
  ansible.builtin.set_fact:
    mcphost_provider_api_key_resolved: "{{ mcphost_provider_api_key }}"
  vars:
    env_var_name: "{{ mcphost_provider_api_key_env_var | default('') | trim }}"
  when: env_var_name | length == 0

- name: Discover MCP servers from configured directories
  when: mcphost_mcp_servers_auto_discover | bool
  tags: ['mcphost', 'config', 'discover']
  block:
    - name: Find MCP server config files (YAML and JSON)
      ansible.builtin.find:
        paths: "{{ item }}"
        patterns: "config.yml,*.json"
        file_type: file
        recurse: true
      loop: "{{ mcphost_mcp_servers_dirs }}"
      register: mcp_server_configs_raw
      failed_when: false
      changed_when: false

    - name: Flatten discovered config files
      ansible.builtin.set_fact:
        discovered_config_files: "{{ discovered_config_files | default([]) + item.files | default([]) }}"
      loop: "{{ mcp_server_configs_raw.results | default([]) }}"
      when: item.files is defined and item.files | length > 0

    - name: Load discovered MCP server configurations (YAML format - from mcp_servers/)
      ansible.builtin.set_fact:
        discovered_mcp_servers_config: "{{ discovered_mcp_servers_config | default({}) | combine(server_config_processed) }}"
        discovered_mcp_servers_dirs: "{{ discovered_mcp_servers_dirs | default({}) | combine(server_dir_mapping) }}"
        discovered_mcp_directories: "{{ discovered_mcp_directories | default({}) | combine({server_dir_name: server_dir}) }}"
      vars:
        config_file: "{{ item.path }}"
        server_dir: "{{ item.path | dirname }}"
        server_dir_name: "{{ server_dir | basename }}"
        config_content_raw: "{{ lookup('template', config_file) }}"
        config_content: "{{ config_content_raw | replace('{{ server_dir }}', server_dir) }}"
        server_config_processed: "{{ config_content | from_yaml }}"
        server_dir_mapping: >-
          {%- set mapping = {} -%}
          {%- for server_name in server_config_processed.keys() -%}
            {%- set _ = mapping.update({server_name: server_dir}) -%}
          {%- endfor -%}
          {{ mapping }}
      loop: "{{ discovered_config_files | default([]) }}"
      when:
        - discovered_config_files is defined
        - discovered_config_files | length > 0
        - item.path is defined
        - (item.path | regex_search('\\.yml$|\\.yaml$')) is not none
      failed_when: false
      changed_when: false
      loop_control:
        label: "{{ item.path | dirname | basename }}"

    - name: Convert relative command paths to absolute paths for local servers
      ansible.builtin.set_fact:
        discovered_mcp_servers_config: "{{ discovered_mcp_servers_config | combine({item.key: server_config_fixed}) }}"
      vars:
        server_config_fixed: >-
          {%- set server = item.value -%}
          {%- if server.type | default('') == 'local' and server.command is defined -%}
            {%- set cmd_raw = server.command | first if (server.command | type_debug == 'list') else server.command -%}
            {%- if cmd_raw.startswith('./') or cmd_raw.startswith('../') -%}
              {%- set cwd_path = server.cwd | default('') -%}
              {%- if cwd_path -%}
                {%- set abs_cmd = cwd_path + '/' + cmd_raw | replace('./', '') -%}
                {%- set is_shell_script = abs_cmd.endswith('.sh') or abs_cmd.endswith('.bash') -%}
                {%- if is_shell_script -%}
                  {%- if server.command | type_debug == 'list' -%}
                    {{ server | combine({'command': ['/bin/bash', abs_cmd]}) }}
                  {%- else -%}
                    {{ server | combine({'command': ['/bin/bash', abs_cmd]}) }}
                  {%- endif -%}
                {%- else -%}
                  {%- if server.command | type_debug == 'list' -%}
                    {{ server | combine({'command': [abs_cmd]}) }}
                  {%- else -%}
                    {{ server | combine({'command': abs_cmd}) }}
                  {%- endif -%}
                {%- endif -%}
              {%- else -%}
                {{ server }}
              {%- endif -%}
            {%- else -%}
              {{ server }}
            {%- endif -%}
          {%- else -%}
            {{ server }}
          {%- endif -%}
      loop: "{{ discovered_mcp_servers_config | dict2items | list }}"
      when:
        - discovered_mcp_servers_config is defined
        - discovered_mcp_servers_config | length > 0
      failed_when: false
      changed_when: false
      loop_control:
        label: "{{ item.key }}"

    - name: Load discovered MCP server configurations (JSON format - from package examples)
      ansible.builtin.set_fact:
        discovered_mcp_servers_config: "{{ discovered_mcp_servers_config | default({}) | combine(package_servers) }}"
      vars:
        config_file: "{{ item.path }}"
        config_content: "{{ lookup('file', config_file) }}"
        config_parsed: "{{ config_content | from_json }}"
        package_servers: "{{ config_parsed.mcpServers | default({}) }}"
      loop: "{{ discovered_config_files | default([]) }}"
      when:
        - discovered_config_files is defined
        - discovered_config_files | length > 0
        - item.path is defined
        - item.path | regex_search('\\.json$') is not none
        - config_parsed.mcpServers is defined
        - config_parsed.mcpServers | length > 0
      failed_when: false
      changed_when: false
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Build MCP directory filter lists from requested directory names
      ansible.builtin.set_fact:
        requested_directory_filters: >-
          {%- set filters = mcphost_mcp_servers_filter | default([]) -%}
          {%- set filters_type = filters | type_debug -%}
          {%- if filters_type in ['list', 'tuple', 'AnsibleSequence'] -%}
            {{ filters }}
          {%- elif filters is string -%}
            {%- set parsed = (filters | trim) | from_yaml -%}
            {%- set parsed_type = parsed | type_debug -%}
            {%- if parsed_type in ['list', 'tuple', 'AnsibleSequence'] -%}
              {{ parsed }}
            {%- elif parsed is string -%}
              [{{ parsed }}]
            {%- else -%}
              [{{ filters | trim }}]
            {%- endif -%}
          {%- elif filters | length is defined and filters | length == 0 -%}
            []
          {%- else -%}
            [{{ filters }}]
          {%- endif -%}
      when:
        - mcphost_mcp_servers_filter is defined
        - mcphost_mcp_servers_filter | length > 0
      changed_when: false
      failed_when: false

    - name: Get server names from requested directories
      ansible.builtin.set_fact:
        expanded_mcp_servers_filter: >-
          {%- set server_list = [] -%}
          {%- for dir_name in requested_directory_filters -%}
            {%- if discovered_mcp_directories[dir_name] is defined -%}
              {%- set dir_path = discovered_mcp_directories[dir_name] -%}
              {%- for server_name, server_dir in discovered_mcp_servers_dirs.items() -%}
                {%- if server_dir == dir_path -%}
                  {%- set _ = server_list.append(server_name) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ server_list }}
        missing_directory_filters: >-
          {%- set missing = [] -%}
          {%- for dir_name in requested_directory_filters -%}
            {%- if discovered_mcp_directories[dir_name] is not defined -%}
              {%- set _ = missing.append(dir_name) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ missing }}
      vars:
        requested_directory_filters: "{{ requested_directory_filters | default([]) }}"
      when:
        - discovered_mcp_servers_config is defined
        - discovered_mcp_directories is defined
        - discovered_mcp_servers_dirs is defined
        - requested_directory_filters is defined
        - requested_directory_filters | length > 0
      changed_when: false
      failed_when: false

    - name: Fail if requested MCP directories were not discovered
      ansible.builtin.fail:
        msg: >-
          Requested MCP server directories were not discovered: {{ missing_directory_filters | join(', ') }}.
          Available directories: {{ discovered_mcp_directories.keys() | list | join(', ') }}.
      when:
        - missing_directory_filters is defined
        - missing_directory_filters | length > 0

    - name: Filter discovered servers by directory (if filter is specified)
      ansible.builtin.set_fact:
        discovered_mcp_servers_config: "{{ discovered_mcp_servers_config | dict2items | selectattr('key', 'in', expanded_mcp_servers_filter) | items2dict }}"
      when:
        - discovered_mcp_servers_config is defined
        - expanded_mcp_servers_filter is defined
        - expanded_mcp_servers_filter | length > 0

    - name: Clear discovered servers if no filter is specified (no auto-discovery)
      ansible.builtin.set_fact:
        discovered_mcp_servers_config: {}
      when:
        - discovered_mcp_servers_config is defined
        - mcphost_mcp_servers_filter is not defined or mcphost_mcp_servers_filter | length == 0

    - name: Get directories of enabled MCP servers from requested directory filters
      ansible.builtin.set_fact:
        enabled_mcp_servers_dirs: "{{ enabled_mcp_servers_dirs | default([]) + [discovered_mcp_directories[item]] }}"
      loop: "{{ requested_directory_filters | default([]) }}"
      when:
        - discovered_mcp_directories is defined
        - requested_directory_filters is defined
        - requested_directory_filters | length > 0
        - discovered_mcp_directories[item] is defined
      loop_control:
        label: "{{ item }}"

    - name: Discover system-prompt files from enabled MCP server directories only
      ansible.builtin.find:
        paths: "{{ item }}"
        patterns: "system-prompt"
        file_type: file
      loop: "{{ enabled_mcp_servers_dirs | default([]) | unique }}"
      register: mcp_system_prompts_raw
      failed_when: false
      changed_when: false
      when:
        - enabled_mcp_servers_dirs is defined
        - enabled_mcp_servers_dirs | length > 0

    - name: Flatten discovered system-prompt files
      ansible.builtin.set_fact:
        discovered_system_prompt_files: "{{ discovered_system_prompt_files | default([]) + item.files | default([]) }}"
      loop: "{{ mcp_system_prompts_raw.results | default([]) }}"
      when:
        - mcp_system_prompts_raw is defined
        - item.files is defined
        - item.files | length > 0

    - name: Set discovered system-prompt file if no explicit prompt is configured
      ansible.builtin.set_fact:
        mcphost_system_prompt_file_discovered: "{{ (discovered_system_prompt_files | first).path | default('') }}"
      when:
        - discovered_system_prompt_files is defined
        - discovered_system_prompt_files | length > 0
        - mcphost_system_prompt_file | default('') | length == 0
        - mcphost_system_prompt | default('') | length == 0

- name: Convert manually configured servers to dict format
  ansible.builtin.set_fact:
    manual_mcp_servers_dict: "{{ manual_mcp_servers_dict | default({}) | combine({item.name: manual_server_dict}) }}"
  # yamllint disable rule:line-length
  vars:
    manual_server_dict: >-
      {%- set server = {} -%}
      {%- if item.type == 'builtin' -%}
        {%- set _ = server.update({'type': 'builtin', 'name': item.builtin_name}) -%}
        {%- if item.options is defined -%}{%- set _ = server.update({'options': item.options}) -%}{%- endif -%}
        {%- if item.allowed_tools is defined -%}{%- set _ = server.update({'allowedTools': item.allowed_tools}) -%}{%- endif -%}
      {%- elif item.type == 'local' -%}
        {%- set _ = server.update({'type': 'local'}) -%}
        {%- if item.command is defined -%}{%- set _ = server.update({'command': item.command}) -%}{%- endif -%}
        {%- if item.cwd is defined -%}{%- set _ = server.update({'cwd': item.cwd}) -%}{%- endif -%}
        {%- if item.environment is defined -%}{%- set _ = server.update({'environment': item.environment}) -%}{%- elif item.env is defined -%}{%- set _ = server.update({'environment': item.env}) -%}{%- endif -%}
      {%- elif item.type == 'remote' -%}
        {%- set _ = server.update({'type': 'remote', 'url': item.url}) -%}
      {%- endif -%}
      {%- if item.description is defined -%}{%- set _ = server.update({'description': item.description}) -%}{%- endif -%}
      {{ server }}
  loop: "{{ mcphost_mcp_servers | default([]) }}"
  when:
    - mcphost_mcp_servers is defined
    - mcphost_mcp_servers | length > 0
  failed_when: false

- name: Merge all MCP servers (discovered + manual)
  ansible.builtin.set_fact:
    final_mcp_servers: "{{ (discovered_mcp_servers_config | default({})) | combine(manual_mcp_servers_dict | default({})) }}"

- name: Ensure final_mcp_servers exists
  ansible.builtin.set_fact:
    final_mcp_servers: "{{ final_mcp_servers | default({}) }}"

- name: Check if local server commands exist
  ansible.builtin.stat:
    path: "{{ command_path }}"
  register: command_check
  vars:
    is_local_server: "{{ item.value.type | default('') == 'local' or (item.value.type is not defined and item.value.command is defined) }}"
    command_list: "{{ item.value.command if (item.value.command | type_debug == 'list') else [item.value.command] }}"
    command_raw: >-
      {%- if command_list | length > 1 -%}
        {{ command_list | last }}
      {%- else -%}
        {{ command_list | first }}
      {%- endif -%}
    command_name: "{{ command_raw | basename }}"
    command_path: >-
      {%- if command_raw.startswith('./') -%}
        {{ (item.value.cwd | default('')) + '/' + command_raw | replace('./', '') }}
      {%- elif command_raw.startswith('../') -%}
        {{ (item.value.cwd | default('')) + '/' + command_raw }}
      {%- elif command_raw.startswith('/') -%}
        {{ command_raw }}
      {%- else -%}
        /dev/null
      {%- endif -%}
    is_relative_path: "{{ command_raw.startswith('./') or command_raw.startswith('../') or command_raw.startswith('/') }}"
  loop: "{{ final_mcp_servers | dict2items | list }}"
  when:
    - final_mcp_servers is defined
    - is_local_server | bool
    - item.value.command is defined
    - is_relative_path | bool
  failed_when: false
  changed_when: false
  loop_control:
    label: "{{ item.key }}"

- name: Check if command exists in PATH (for non-relative paths)
  ansible.builtin.command:
    cmd: "which {{ command_name }}"
  register: command_check_path
  vars:
    is_local_server: "{{ item.value.type | default('') == 'local' or (item.value.type is not defined and item.value.command is defined) }}"
    command_list: "{{ item.value.command if (item.value.command | type_debug == 'list') else [item.value.command] }}"
    command_raw: >-
      {%- if command_list | length > 1 -%}
        {{ command_list | last }}
      {%- else -%}
        {{ command_list | first }}
      {%- endif -%}
    command_name: "{{ command_raw | basename }}"
    is_relative_path: "{{ command_raw.startswith('./') or command_raw.startswith('../') or command_raw.startswith('/') }}"
  loop: "{{ final_mcp_servers | dict2items | list }}"
  when:
    - final_mcp_servers is defined
    - is_local_server | bool
    - item.value.command is defined
    - not (is_relative_path | bool)
  failed_when: false
  changed_when: false
  loop_control:
    label: "{{ item.key }}"

- name: Validate local server commands exist (relative/absolute paths)
  ansible.builtin.set_fact:
    valid_servers: "{{ valid_servers | default({}) | combine({item.item.key: item.item.value}) }}"
  loop: "{{ command_check.results | default([]) }}"
  when:
    - command_check is defined
    - not item.skipped | default(false) | bool
    - item.stat is defined
    - item.stat.exists | default(false) | bool
  changed_when: false

- name: Validate commands found in PATH
  ansible.builtin.set_fact:
    valid_servers: "{{ valid_servers | default({}) | combine({item.item.key: item.item.value}) }}"
  loop: "{{ command_check_path.results | default([]) }}"
  when:
    - command_check_path is defined
    - not item.skipped | default(false) | bool
    - item.rc is defined
    - item.rc == 0
  changed_when: false

- name: Warn about invalid MCP server commands
  ansible.builtin.debug:
    msg: >-
      Skipping MCP server '{{ item.key }}' because its command '{{ (item.value.command | default('unknown command')) }}' was not found.
  loop: "{{ final_mcp_servers | default({}) | dict2items | list }}"
  when:
    - final_mcp_servers is defined
    - valid_servers is defined
    - item.key not in valid_servers
    - (item.value.type | default('')) in ['local', '']
    - item.value.command is defined
  changed_when: false
  failed_when: false

- name: Update final MCP servers list with only valid entries
  ansible.builtin.set_fact:
    final_mcp_servers: "{{ valid_servers | default(final_mcp_servers | default({})) }}"

- name: Render mcphost configuration file
  ansible.builtin.template:
    src: mcphost-config.yml.j2
    dest: "{{ mcphost_config_path }}"
    mode: "0644"
  vars:
    mcphost_generated_timestamp: "{{ lookup('pipe', 'date --iso-8601=seconds') }}"
    mcp_servers: "{{ final_mcp_servers | default({}) }}"

- name: Display mcphost hint
  ansible.builtin.debug:
    msg: |
      mcphost is ready. Start it with:

        {{ mcphost_executable }}

      Configuration file: {{ mcphost_config_path }}
      Drop additional MCP servers under roles/ansible-ollama_mcphost/mcp_servers/ or ~/mcp_servers/ to have them auto-discovered.
