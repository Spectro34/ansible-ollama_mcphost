---
# Main tasks for ollama_mcphost role

# ========================================
# CLEANUP TASKS (run with --tags cleanup)
# ========================================

- name: Stop Ollama service
  systemd:
    name: ollama
    state: stopped
    enabled: no
  become: yes
  ignore_errors: yes
  tags: [never, cleanup]

- name: Remove Ollama models
  command: "ollama rm {{ ollama_model }}"
  register: model_remove
  failed_when: false
  changed_when: model_remove.rc == 0
  when: cleanup_models
  tags: [never, cleanup]

- name: Uninstall packages
  package:
    name: "{{ packages_to_install }}"
    state: absent
  become: yes
  tags: [never, cleanup]

- name: Remove mcphost configuration
  file:
    path: "{{ ansible_env.HOME }}/.mcphost.yml"
    state: absent
  when: cleanup_config
  tags: [never, cleanup]

- name: Remove Ollama data directory
  file:
    path: "{{ ansible_env.HOME }}/.ollama"
    state: absent
  when: cleanup_data
  tags: [never, cleanup]

- name: Remove mcphost config directory
  file:
    path: "{{ mcphost_config_dir }}"
    state: absent
  when: cleanup_config
  tags: [never, cleanup]

- name: Cleanup complete
  debug:
    msg: |
      âœ“ Cleanup complete
      - Ollama service stopped
      - Packages uninstalled
      - Configuration removed
      - Data directories cleaned
  tags: [never, cleanup]

# ========================================
# INSTALLATION TASKS (default)
# ========================================

- name: Install Ollama and mcphost
  package:
    name: "{{ packages_to_install }}"
    state: present
  become: yes
  when: install_packages
  register: package_install
  tags: [install]

- name: Display installation result
  debug:
    msg: "âœ“ Installed: {{ packages_to_install | join(', ') }}"
  when: package_install is changed
  tags: [install]

- name: Ensure Ollama service is running
  systemd:
    name: ollama
    state: started
    enabled: yes
  become: yes
  tags: [service]

- name: Wait for Ollama to be ready
  wait_for:
    host: "{{ ollama_host }}"
    port: "{{ ollama_service_port }}"
    timeout: 30
  tags: [service, verify]

# ========================================
# MODEL TASKS
# ========================================

- name: Check if model is already downloaded
  command: ollama list
  register: ollama_models
  changed_when: false
  tags: [model, verify]

- name: Pull Ollama model
  command: "ollama pull {{ ollama_model }}"
  when: ollama_model not in ollama_models.stdout
  register: model_pull
  async: 600
  poll: 10
  tags: [model]

- name: Display model info
  command: "ollama show {{ ollama_model }}"
  register: model_info
  changed_when: false
  failed_when: false
  tags: [model, verify]

- name: Show model details
  debug:
    msg: |
      âœ“ Model ready: {{ ollama_model }}
      Details: {{ model_info.stdout_lines[:5] | join('\n') if model_info.rc == 0 else 'Model info unavailable' }}
  tags: [model, verify]

# ========================================
# VERIFICATION TASKS
# ========================================

- name: Verify mcphost is installed
  command: which mcphost
  register: mcphost_check
  changed_when: false
  tags: [verify]

- name: Get mcphost version
  command: mcphost --version
  register: mcphost_version
  changed_when: false
  tags: [verify]

- name: Display mcphost status
  debug:
    msg: "âœ“ mcphost: {{ mcphost_version.stdout | default('Installed') }}"
  tags: [verify]

# ========================================
# CONFIGURATION TASKS
# ========================================

- name: Create mcphost config directory
  file:
    path: "{{ mcphost_config_dir }}"
    state: directory
    mode: '0755'
  tags: [config]

- name: Create mcphost configuration from template
  template:
    src: mcphost-config.yml.j2
    dest: "{{ ansible_env.HOME }}/.mcphost.yml"
    mode: '0644'
  register: config_created
  tags: [config]

- name: Display configuration location
  debug:
    msg: "âœ“ mcphost config created: {{ ansible_env.HOME }}/.mcphost.yml ({{ mcp_servers | length }} MCP server(s) configured)"
  tags: [config, verify]

# ========================================
# TESTING TASKS
# ========================================

- name: Test Ollama API
  uri:
    url: "http://{{ ollama_host }}:{{ ollama_service_port }}/api/tags"
    method: GET
  register: ollama_api
  failed_when: false
  ignore_errors: yes
  tags: [verify]

- name: Verify Ollama is responding
  debug:
    msg: "âœ“ Ollama API is accessible"
  when: 
    - ollama_api is defined
    - ollama_api.status is defined
    - ollama_api.status == 200
  tags: [verify]

# ========================================
# SUMMARY
# ========================================

- name: Display setup summary
  debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘  Ollama + MCPHost Setup Complete                         â•‘
      â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
      â•‘  Ollama: http://{{ ollama_host }}:{{ ollama_service_port }}
      â•‘  Model: {{ ollama_model }}
      â•‘  mcphost: {{ mcphost_version.stdout | default('Installed') }}
      â•‘  Config: {{ ansible_env.HOME }}/.mcphost.yml
      â•‘  
      â•‘  Parameters:
      â•‘    Temperature: {{ temperature }}
      â•‘    Max Tokens: {{ max_tokens }}
      â•‘    Max Steps: {{ max_steps }}
      â•‘  
      â•‘  MCP Servers: {{ mcp_servers | length }}
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tags: [always]

- name: Instructions for using mcphost
  debug:
    msg: |
      
      ðŸš€ Ready to use! Start mcphost:
      
        mcphost
      
      Test commands:
        > /servers    # List configured MCP servers
        > /tools      # Show available MCP tools
        > Hello       # Chat with the AI
  tags: [always]

