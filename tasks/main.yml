---
# Main orchestration for the ansible-ollama_mcphost role.

- name: Auto-refresh package metadata (import keys)
  ansible.builtin.command:
    argv: "{{ package_refresh_command }}"
  become: true
  changed_when: false
  when:
    - package_auto_refresh
    - ansible_facts.pkg_mgr == 'zypper'

- name: Install Ollama stack
  when: ollama_state == 'present'
  tags: ['ollama', 'install']
  block:
    - name: Install Ollama
      ansible.builtin.package:
        name: "{{ ollama_package_name }}"
        state: present
      become: true

    - name: Ensure systemd override directory exists
      ansible.builtin.file:
        path: "/etc/systemd/system/{{ ollama_service_name }}.service.d"
        state: directory
        mode: "0755"
      become: true

    - name: Configure GPU drop-in
      ansible.builtin.copy:
        dest: "/etc/systemd/system/{{ ollama_service_name }}.service.d/override.conf"
        content: |
          [Service]
          Environment=OLLAMA_USE_GPU=1
          {% if ollama_gpu_runtime %}
          Environment=OLLAMA_GPU_DRIVER={{ ollama_gpu_runtime }}
          {% endif %}
        mode: "0644"
      become: true
      notify: Reload Ollama daemon
      when: ollama_gpu_enabled

    - name: Remove GPU drop-in when disabled
      ansible.builtin.file:
        path: "/etc/systemd/system/{{ ollama_service_name }}.service.d/override.conf"
        state: absent
      become: true
      notify: Reload Ollama daemon
      when: not ollama_gpu_enabled

    - name: Ensure Ollama service is running
      ansible.builtin.systemd:
        name: "{{ ollama_service_name }}"
        state: started
        enabled: true
      become: true
      ignore_errors: true

    - name: Pull requested Ollama models
      ansible.builtin.command: "{{ ollama_binary_path }} pull {{ item }}"
      loop: "{{ ollama_pull_models }}"
      when: ollama_pull_models | length > 0

- name: Remove Ollama stack
  when: ollama_state == 'absent'
  tags: ['ollama', 'cleanup']
  block:
    - name: Stop Ollama service
      ansible.builtin.systemd:
        name: "{{ ollama_service_name }}"
        state: stopped
        enabled: false
      become: true
      ignore_errors: true

    - name: Remove GPU drop-in
      ansible.builtin.file:
        path: "/etc/systemd/system/{{ ollama_service_name }}.service.d/override.conf"
        state: absent
      become: true
      notify: Reload Ollama daemon

    - name: Remove Ollama models
      ansible.builtin.command: "{{ ollama_binary_path }} rm --all"
      when: ollama_cleanup_models
      ignore_errors: true

    - name: Remove Ollama package
      ansible.builtin.package:
        name: "{{ ollama_package_name }}"
        state: absent
      become: true
      when: ollama_cleanup_binary

    - name: Remove Ollama data directory
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.ollama"
        state: absent
      when: ollama_cleanup_data

- name: Install mcphost client
  when: mcphost_state == 'present'
  tags: ['mcphost', 'install', 'config']
  block:
    - name: Install mcphost
      ansible.builtin.package:
        name: "{{ mcphost_package_name }}"
        state: present
      become: true

    - name: Compute endpoint list
      ansible.builtin.set_fact:
        mcphost_endpoints_effective: >-
          {{
            (mcphost_endpoints + [default_endpoint])
            if risu_mcp_configure_endpoint else mcphost_endpoints
          }}
      vars:
        default_endpoint:
          name: "{{ risu_mcp_name }}"
          endpoint: "http://{{ risu_mcp_host }}:{{ risu_mcp_port }}"
          description: "{{ risu_mcp_description }}"

    - name: Ensure mcphost config directory exists
      ansible.builtin.file:
        path: "{{ mcphost_config_path | dirname }}"
        state: directory
        mode: "0755"

    - name: Render mcphost configuration
      ansible.builtin.template:
        src: mcphost-config.yml.j2
        dest: "{{ mcphost_config_path }}"
        mode: "0644"

    - name: Display mcphost hint
      ansible.builtin.debug:
        msg: |
          mcphost is ready. Start it with:

            {{ mcphost_executable }}

- name: Remove mcphost client
  when: mcphost_state == 'absent'
  tags: ['mcphost', 'cleanup']
  block:
    - name: Remove mcphost configuration
      ansible.builtin.file:
        path: "{{ mcphost_config_path }}"
        state: absent

    - name: Remove mcphost package
      ansible.builtin.package:
        name: "{{ mcphost_package_name }}"
        state: absent
      become: true
      when: mcphost_cleanup_package
